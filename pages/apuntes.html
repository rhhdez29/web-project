<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Apuntes</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="../assets/styles/apuntes.css">
</head>
<body>
  <div class="contenedor-principal">
    <nav>
      <div class="D">
        <label class="switch">
          <input type="checkbox" id="toggle-mode">
          <span class="slider">
            <span class="icon">‚òÄÔ∏è</span>
            <span class="icon">üåô</span>
          </span>
        </label>
      </div>
    </nav>
    <!-- Barra lateral -->
    <div id="toolbar">
      <div class="tool" draggable="true" data-type="heading">
        <img src="../assets/imagenes/elemento.svg" alt="icono de texto">
        <p>Subt√≠tulo</p>
      </div>
      <div class="tool" draggable="true" data-type="text">
        <img src="../assets/imagenes/elemento.svg" alt="icono de texto">
        <p>Texto</p>
      </div>
      <div class="tool" draggable="true" data-type="bullet">
        <img src="../assets/imagenes/elemento.svg" alt="icono de texto">
        <p>Lista</p>
      </div>
      <div class="tool" draggable="true" data-type="list">
        <img src="../assets/imagenes/elemento.svg" alt="icono de texto">
        <p>Lista numerada</p>
      </div>
      <div class="tool" draggable="true" data-type="table">
        <img src="../assets/imagenes/elemento.svg" alt="icono de texto">
        <p>Tabla</p>
      </div>
      <div class="tool" draggable="true" data-type="text">
        <img src="../assets/imagenes/elemento.svg" alt="icono de texto">
        <p>F√≥rmulas</p>
      </div>
      <div class="tool" draggable="true" data-type="hyperText">
        <img src="../assets/imagenes/elemento.svg" alt="icono de texto">
        <p>Hiperv√≠nculo</p>
      </div>
      <div class="tool" draggable="true" data-type="text">
        <img src="../assets/imagenes/elemento.svg" alt="icono de texto">
        <p>Nota</p>
      </div>
      <div class="tool" draggable="true" data-type="text">
        <img src="../assets/imagenes/elemento.svg" alt="icono de texto">
        <p>Archivo</p>
      </div>
      <div class="tool" draggable="true" data-type="text">
        <img src="../assets/imagenes/elemento.svg" alt="icono de texto">
        <p>Audio</p>
      </div>
      <div class="tool" draggable="true" data-type="text">
        <img src="../assets/imagenes/elemento.svg" alt="icono de texto">
        <p>Gr√°fico</p>
      </div>
      <div class="tool" draggable="true" data-type="text">
        <img src="../assets/imagenes/elemento.svg" alt="icono de texto">
        <p>Video</p>
      </div>
  
      <!-- Botones extra -->
      <button id="add-image-btn" class="pdf-tool">
        <img src="../assets/imagenes/elemento.svg" alt="Imagen">
        <p>Imagen</p>
      </button>
      <button onclick="exportarContenido()" class="pdf-tool">
        <img src="../assets/imagenes/elemento.svg" alt="PDF">
        <p>Exportar PDF</p>
      </button>
    </div>
  
    <!-- Contenido principal -->
    <div id="Contenido">
      <div class="imagen-wrapper portada-wrapper">
        <img class="portada" src="../assets/imagenes/fondo2.jpg" alt="Fondo">
        <div class="imagen-texto">Cambiar imagen</div>
      </div>
  
      <div class="contenedor-centrado">
        <div class="imagen-wrapper redonda">
          <img class="icono" src="../assets/imagenes/perfil.png" alt="Perfil">
          <div class="imagen-texto">Cambiar foto</div>
        </div>
        <h1 id="editable-title" contenteditable="true" class="editable-h1"></h1>
  
        <!-- √Årea de trabajo -->
        <div id="workspace" ondragover="event.preventDefault()"></div>
      </div>
    </div>
  </div>
  
  
  <!-- Men√∫ contextual -->
  <div id="context-menu">
    <select id="font-select">
      <option value="Arial">Arial</option>
      <option value="Segoe UI">Segoe UI</option>
      <option value="Georgia">Georgia</option>
      <option value="Courier New">Courier New</option>
    </select>
    <input type="number" id="font-size" placeholder="Tama√±o de fuente" min="8" max="72" value="16">
    <div style="display: flex; gap: 8px;">
      <div style="flex: 1;">
        <label style="font-size: 12px; color: #666;">Color texto</label>
        <input type="color" id="text-color" value="#000000">
      </div>
      <div style="flex: 1;">
        <label style="font-size: 12px; color: #666;">Color fondo</label>
        <input type="color" id="bg-color" value="#ffffff">
      </div>
    </div>
    <button id="delete-block" style="background: #ff4d4d; color: white; border: none; margin-top: 8px;">üóëÔ∏è Eliminar bloque</button>
  </div>

  <!-- Ventana flotante para elegir imagen -->
<div id="image-picker-modal" style="display: none; position: fixed; top: 50%; left: 50%; 
transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; 
box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 1000;">
  <h3>Elige una imagen</h3>
  <div id="image-picker-options" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
    <!-- Aqu√≠ se insertan las miniaturas -->
  </div>
  <button id="close-image-picker" style="margin-top: 15px;">Cancelar</button>
</div>



<script src="../scripts/apuntes.js"></script>
<script>
  async function exportarContenido() {
  const { jsPDF } = window.jspdf;
  const contenido = document.getElementById("Contenido");
  const rawTitle = document.getElementById("editable-title").innerText.trim() || "Archivo";
  const titulo = rawTitle.replace(/[^a-z0-9√°√©√≠√≥√∫√±√º \-_]/gi, '').substring(0, 50);

  try {
    // 1. Aplicar estilos de impresi√≥n antes de capturar
    document.getElementById('Contenido').classList.add('printing-pdf');
    
    // 2. Forzar c√°lculo de estilos (reflow)
    void document.getElementById('Contenido').offsetHeight;
    
    // 3. Configurar html2canvas con las dimensiones reales del contenido
    const canvas = await html2canvas(contenido, {
      scale: 2,
      logging: true,
      useCORS: true,
      scrollX: 0,
      scrollY: 0,
      windowWidth: contenido.scrollWidth,
      windowHeight: contenido.scrollHeight,
      backgroundColor: '#FFFFFF'
    });

    // 4. Remover estilos de impresi√≥n despu√©s de capturar
    document.getElementById('Contenido').classList.remove('printing-pdf');
    
    const imgData = canvas.toDataURL("image/png", 1.0);

    // 5. Crear PDF con tama√±o adecuado (A4 en mm)
    const pdf = new jsPDF({
      orientation: "portrait",
      unit: "mm",
      format: "a4"
    });

    // 6. Calcular dimensiones para ajustar al PDF manteniendo relaci√≥n de aspecto
    const imgProps = pdf.getImageProperties(imgData);
    const pdfWidth = pdf.internal.pageSize.getWidth() - 20; // Margen 10mm cada lado
    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
    
    // 7. Centrar la imagen en el PDF con m√°rgenes
    const xPos = 10; // Margen izquierdo 10mm
    const yPos = 10; // Margen superior 10mm
    
    pdf.addImage(imgData, 'PNG', xPos, yPos, pdfWidth, pdfHeight);
    
    // 8. Guardar el PDF
    pdf.save(titulo + ".pdf");

  } catch (err) {
    document.getElementById('Contenido').classList.remove('printing-pdf')
    console.error("Error al generar el PDF:", err);
    alert("Ocurri√≥ un error al generar el PDF. Revisa la consola.");
  }
}
</script>
</body>
</html>
